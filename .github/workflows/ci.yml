name: Continuous Integration

on:
  push:
    branches:
    - master
    - develop

    paths:
    - cmake-init/**
    - .github/workflows/*

  pull_request:
    branches:
    - develop

    paths:
    - cmake-init/**
    - .github/workflows/*

jobs:
  test:
    strategy:
      fail-fast: false

      matrix:
        job: [0, 1, 2, 3]

        os: [macos, ubuntu, windows]

        include:
        - { job: 0, type: -s, name: "Library: shared", flag: "-D BUILD_SHARED_LIBS=YES" }
        - { job: 1, type: -s, name: "Library: static", flag: "" }
        - { job: 2, type: -h, name: "Library: header-only", flag: "" }
        - { job: 3, type: -e, name: "Executable", flag: "" }
        # CMake by default will pick 10.0.17763.0 up, but that has bugs in it
        # that make it emit warnings with the new conforming preprocessor
        - { os: windows, sdk_flag: "-D CMAKE_SYSTEM_VERSION=10.0.18362" }

    name: ${{ matrix.name }} (${{ matrix.os }})

    runs-on: ${{ matrix.os }}-latest

    steps:
    - uses: actions/checkout@v1

    - name: Install clang-tidy
      if: matrix.os == 'ubuntu'
      run: sudo apt-get install clang-tidy -y -q

    - uses: actions/setup-python@v2
      with: { python-version: "3.8" }

    - name: Create project
      run: |
        python -m zipapp cmake-init -p "/usr/bin/env python3"
        python cmake-init.pyz ${{ matrix.type }} proj

    - name: Configure
      working-directory: proj
      run: cmake --preset=ci-${{ matrix.os }} ${{ matrix.flag }}
        ${{ matrix.sdk_flag }}

    - name: Build
      working-directory: proj
      run: cmake --build build --config Release

    - name: Install
      working-directory: proj
      run: cmake --install build --config Release --prefix prefix

    - name: Test
      working-directory: proj/build
      run: ctest -C Release

  release:
    name: Package a release

    if: github.ref == 'refs/heads/master'

    needs: test

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v1

    - uses: actions/setup-python@v2
      with: { python-version: "3.8" }

    - name: Package
      run: python -m zipapp cmake-init -p "/usr/bin/env python3"

    - name: Get version
      id: version
      run: echo "::set-output name=version::$(python cmake-init.pyz --version)"

    - name: Release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: cmake-init.pyz
        prerelease: true
        tag_name: v${{ steps.version.outputs.version }}
        body: Release of version ${{ steps.version.outputs.version }}
        name: v${{ steps.version.outputs.version }}
